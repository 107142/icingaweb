#!/bin/bash

. /opt/helpers

ALL_MESSAGES=""

function announce(){
	local  author="${ICINGAWEB2_ADMIN_USER}"
	local message="${1}"
	local    hash="$(md5sum <<< "${message}" | awk '{print $1}')"
	local   start=$(date '+%s' --date='today')
	local     end=$(date '+%s' --date='year')

	local message_website="$(sed 's/\\n/ /g'    <<< ${message})"
	local message_console="$(sed 's/\\n/\n  /g' <<< ${message})"

	ini_set /etc/icingaweb2/announcements.ini "$hash" "author"  "\"$author\""
	ini_set /etc/icingaweb2/announcements.ini "$hash" "message" "\"$message_website\""
	ini_set /etc/icingaweb2/announcements.ini "$hash" "start"   "\"$start\""
	ini_set /etc/icingaweb2/announcements.ini "$hash" "end"     "\"$end\""
	ini_set /etc/icingaweb2/announcements.ini "$hash" "hash"    "\"$hash\""

	ALL_MESSAGES+="- ${message_console}"$'\n'
}

if hostname | grep -qP '^[0-9a-f]{12}$'; then
	announce "The hostname of this container is randomly generated by docker.\nPlease set your hostname by either using '--hostname' or setting the 'hostname' field in your 'docker-compose.yml' to prevent CA trust issues in API connections."
fi

if [ "${ALL_MESSAGES}" != "" ]; then
	cat >&2 <<-END
	===================================================================

	                      INFO

	${ALL_MESSAGES}
	END
fi
