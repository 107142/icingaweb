#!/bin/bash

. /opt/helpers

if evaluate_boolean "${ICINGAWEB2_MAP}"; then
	echo "Map: Enabling Icingaweb2 map module"

	ICINGAWEB2_MAP_DEFAULT_ZOOM=${ICINGAWEB2_MAP_DEFAULT_ZOOM:-4}
	ICINGAWEB2_MAP_DEFAULT_LAT=${ICINGAWEB2_MAP_DEFAULT_LAT:-52.515855}
	ICINGAWEB2_MAP_DEFAULT_LON=${ICINGAWEB2_MAP_DEFAULT_LON:-13.377485}
	ICINGAWEB2_MAP_STATETYPE=${ICINGAWEB2_MAP_STATETYPE:-soft}
	ICINGAWEB2_MAP_MAX_ZOOM=${ICINGAWEB2_MAP_MAX_ZOOM:-19}
	ICINGAWEB2_MAP_MAX_NATIVE_ZOOM=${ICINGAWEB2_MAP_MAX_NATIVE_ZOOM:-19}
	ICINGAWEB2_MAP_MIN_ZOOM=${ICINGAWEB2_MAP_MIN_ZOOM:-2}
	ICINGAWEB2_MAP_DASHLET_HEIGHT=${ICINGAWEB2_MAP_DASHLET_HEIGHT:-300}
	ICINGAWEB2_MAP_TITLE_URL=${ICINGAWEB2_MAP_TITLE_URL:-//{s}.tile.openstreetmap.org/{z}/{x}/{y}.png}
	ICINGAWEB2_MAP_CLUSTER_PROBLEM_COUNT=${ICINGAWEB2_MAP_CLUSTER_PROBLEM_COUNT:-0}
	ICINGAWEB2_MAP_DISABLE_CLUSTER_AT_ZOOM=${ICINGAWEB2_MAP_DISABLE_CLUSTER_AT_ZOOM:-18}

	ICINGAWEB2_MAP_CONFIG_PATH=/etc/icingaweb2/modules/map
	ICINGAWEB2_MAP_CONFIG=${ICINGAWEB2_MAP_CONFIG_PATH}/config.ini

	icingacli module enable map
	icingacli module enable globe

	echo "Map: Configure"
	mkdir -p ${ICINGAWEB2_MAP_CONFIG_PATH}
	touch ${ICINGAWEB2_MAP_CONFIG}

	ini_set ${ICINGAWEB2_MAP_CONFIG} map default_zoom		\"${ICINGAWEB2_MAP_DEFAULT_ZOOM}\"
	ini_set ${ICINGAWEB2_MAP_CONFIG} map default_lat		\"${ICINGAWEB2_MAP_DEFAULT_LAT}\"
	ini_set ${ICINGAWEB2_MAP_CONFIG} map default_long		\"${ICINGAWEB2_MAP_DEFAULT_LON}\"
	ini_set ${ICINGAWEB2_MAP_CONFIG} map stateType			\"${ICINGAWEB2_MAP_STATETYPE}\"
	ini_set ${ICINGAWEB2_MAP_CONFIG} map max_zoom			\"${ICINGAWEB2_MAP_MAX_ZOOM}\"
	ini_set ${ICINGAWEB2_MAP_CONFIG} map max_native_zoom		\"${ICINGAWEB2_MAP_MAX_NATIVE_ZOOM}\"
	ini_set ${ICINGAWEB2_MAP_CONFIG} map min_zoom			\"${ICINGAWEB2_MAP_MIN_ZOOM}\"
	ini_set ${ICINGAWEB2_MAP_CONFIG} map dashlet_height		\"${ICINGAWEB2_MAP_DASHLET_HEIGHT}\"
	ini_set ${ICINGAWEB2_MAP_CONFIG} map title_url			\"${ICINGAWEB2_MAP_TITLE_URL}\"
	ini_set ${ICINGAWEB2_MAP_CONFIG} map cluster_problem_count	\"${ICINGAWEB2_MAP_CLUSTER_PROBLEM_COUNT}\"
	ini_set ${ICINGAWEB2_MAP_CONFIG} map disable_cluster_at_zoom	\"${ICINGAWEB2_MAP_DISABLE_CLUSTER_AT_ZOOM}\"
	echo -e "Map: Finished configuration\n"
else
	icingacli module disable map || true
	icingacli module disable globe || true
fi
